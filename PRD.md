# PRD: 企業級單一登入與角色權限控管系統 PoC

## 文件資訊

| 項目 | 內容 |
|------|------|
| 文件版本 | 1.0 |
| 建立日期 | 2025-01-10 |
| 專案代號 | SSO-RBAC-POC |
| 文件狀態 | Draft |

---

## 1. 執行摘要

### 1.1 專案背景

企業內部存在多個應用系統，各系統獨立管理使用者帳號與權限，導致以下問題：

- 使用者需記憶多組帳號密碼，降低工作效率
- IT 人員需在各系統重複維護帳號，增加管理成本
- 權限管理分散，難以進行統一稽核
- 離職人員帳號停用作業繁瑣，存在資安風險

### 1.2 專案目標

建立一個概念驗證（PoC）環境，驗證以下技術可行性：

1. **單一登入（SSO）**：使用者僅需登入一次，即可存取所有授權系統
2. **集中式身份管理**：透過 LDAP 統一管理使用者身份資訊
3. **角色型存取控制（RBAC）**：依據角色授予系統功能權限
4. **標準化協定**：採用 OAuth 2.0 / OpenID Connect 業界標準

### 1.3 成功指標

| 指標 | 目標值 | 量測方式 |
|------|--------|----------|
| 登入成功率 | ≥ 99% | 測試案例通過率 |
| Token 驗證時間 | < 100ms | API 響應時間 |
| 權限控制準確度 | 100% | 角色權限測試 |
| 環境部署時間 | < 30 分鐘 | Docker Compose 啟動時間 |

---

## 2. 利害關係人

### 2.1 主要角色

| 角色 | 職責 | 關注點 |
|------|------|--------|
| 產品負責人 | 定義需求優先順序 | 業務價值、時程 |
| 資安架構師 | 安全架構設計 | 合規性、安全性 |
| 應用架構師 | 技術架構設計 | 可擴展性、整合性 |
| 開發團隊 | 系統實作 | 技術可行性、開發效率 |
| 維運團隊 | 環境部署與維護 | 穩定性、可維護性 |

### 2.2 終端使用者

| 使用者類型 | 說明 | 預期人數 |
|------------|------|----------|
| 系統管理員 | 管理使用者、角色、權限 | 5-10 |
| 一般使用者 | 使用業務系統功能 | 100-500 |
| 稽核人員 | 檢視存取記錄與權限報表 | 2-5 |

---

## 3. 功能需求

### 3.1 使用者故事地圖

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                    使用者旅程                            │
                    ├─────────────┬─────────────┬─────────────┬───────────────┤
                    │   登入認證   │   存取資源   │   權限管理   │    稽核追蹤   │
                    ├─────────────┼─────────────┼─────────────┼───────────────┤
  一般使用者        │ US-001      │ US-003      │             │               │
                    │ US-002      │ US-004      │             │               │
                    ├─────────────┼─────────────┼─────────────┼───────────────┤
  系統管理員        │ US-001      │ US-003      │ US-005      │ US-007        │
                    │ US-002      │ US-004      │ US-006      │ US-008        │
                    └─────────────┴─────────────┴─────────────┴───────────────┘
```

### 3.2 使用者故事

#### US-001: 使用者登入

```
作為一個 系統使用者
我想要 透過統一登入頁面進行身份驗證
以便於 一次登入後可存取所有授權的系統

驗收條件：
- 使用者可透過 Keycloak 登入頁面輸入帳號密碼
- 登入成功後取得 JWT Access Token
- Token 包含使用者身份資訊與角色
- 登入失敗顯示明確錯誤訊息
```

#### US-002: Token 自動更新

```
作為一個 已登入的使用者
我想要 系統自動更新我的存取憑證
以便於 不需重複登入即可持續使用系統

驗收條件：
- Access Token 過期前自動使用 Refresh Token 更新
- Refresh Token 過期時導向登入頁面
- Token 更新過程對使用者透明
```

#### US-003: 存取受保護資源

```
作為一個 已登入的使用者
我想要 使用我的 Token 存取 API 資源
以便於 獲取我有權限檢視的資料

驗收條件：
- API 請求需攜帶 Bearer Token
- 有效 Token 可成功存取授權資源
- 無效或過期 Token 回傳 401 Unauthorized
- 權限不足回傳 403 Forbidden
```

#### US-004: 檢視個人資料

```
作為一個 已登入的使用者
我想要 檢視我的個人資料與角色
以便於 確認我的身份資訊正確

驗收條件：
- 顯示使用者名稱、Email、所屬角色
- 資料來源為 JWT Token 中的 Claims
```

#### US-005: 管理使用者帳號

```
作為一個 系統管理員
我想要 在 LDAP 中新增、修改、停用使用者帳號
以便於 控管誰可以存取系統

驗收條件：
- 可透過 LDAP Admin UI 管理使用者
- 新增使用者後可立即使用 SSO 登入
- 停用使用者後無法再登入
```

#### US-006: 管理角色與權限

```
作為一個 系統管理員
我想要 在 Keycloak 中定義角色並指派給使用者
以便於 控管使用者可存取的功能

驗收條件：
- 可建立 Realm Roles（如 ADMIN, USER）
- 可將角色指派給使用者或群組
- 角色變更後下次登入生效
```

#### US-007: 檢視登入記錄

```
作為一個 系統管理員
我想要 檢視使用者的登入歷史記錄
以便於 追蹤異常登入行為

驗收條件：
- Keycloak 記錄所有登入事件
- 可依使用者、時間範圍查詢
- 顯示登入時間、IP、成功/失敗
```

#### US-008: 檢視 API 存取記錄

```
作為一個 稽核人員
我想要 檢視 API 的存取記錄
以便於 進行安全稽核

驗收條件：
- Spring Boot 記錄所有 API 請求
- 包含時間、使用者、API Path、HTTP Method、Response Status
- 日誌可供後續分析使用
```

---

## 4. 非功能需求

### 4.1 安全性需求

| 需求編號 | 需求說明 | 優先級 |
|----------|----------|--------|
| SEC-001 | 密碼傳輸必須使用 HTTPS 加密 | P0 |
| SEC-002 | JWT Token 使用 RS256 演算法簽章 | P0 |
| SEC-003 | Access Token 有效期限不超過 15 分鐘 | P1 |
| SEC-004 | Refresh Token 有效期限不超過 8 小時 | P1 |
| SEC-005 | 連續登入失敗 5 次後鎖定帳號 30 分鐘 | P1 |
| SEC-006 | 敏感操作需記錄稽核日誌 | P1 |

### 4.2 效能需求

| 需求編號 | 需求說明 | 目標值 |
|----------|----------|--------|
| PERF-001 | 登入響應時間 | < 2 秒 |
| PERF-002 | Token 驗證時間 | < 100 毫秒 |
| PERF-003 | API 響應時間（P95） | < 500 毫秒 |
| PERF-004 | 並發使用者數 | ≥ 100 |

### 4.3 可用性需求

| 需求編號 | 需求說明 | 備註 |
|----------|----------|------|
| AVL-001 | 服務可用性 99.9%（正式環境） | PoC 階段不適用 |
| AVL-002 | 單一組件故障不影響整體服務 | PoC 階段簡化 |
| AVL-003 | 支援滾動更新 | PoC 階段不適用 |

### 4.4 可維護性需求

| 需求編號 | 需求說明 |
|----------|----------|
| MNT-001 | 使用 Docker Compose 一鍵部署 |
| MNT-002 | 配置外部化，支援環境變數覆寫 |
| MNT-003 | 提供 Health Check API |
| MNT-004 | 結構化日誌輸出（JSON 格式） |

---

## 5. 系統角色定義

### 5.1 角色階層

```
                    ┌─────────────────┐
                    │   SUPER_ADMIN   │
                    │  (系統最高權限)  │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
      ┌───────┴───────┐             ┌───────┴───────┐
      │     ADMIN     │             │   AUDITOR     │
      │  (管理員權限)  │             │  (稽核權限)   │
      └───────┬───────┘             └───────────────┘
              │
      ┌───────┴───────┐
      │     USER      │
      │  (一般使用者)  │
      └───────────────┘
```

### 5.2 角色權限矩陣

| 功能 / 角色 | USER | ADMIN | AUDITOR | SUPER_ADMIN |
|-------------|:----:|:-----:|:-------:|:-----------:|
| 檢視個人資料 | ✓ | ✓ | ✓ | ✓ |
| 存取一般資源 | ✓ | ✓ | ✓ | ✓ |
| 管理使用者帳號 | - | ✓ | - | ✓ |
| 管理角色權限 | - | ✓ | - | ✓ |
| 檢視稽核日誌 | - | - | ✓ | ✓ |
| 系統設定 | - | - | - | ✓ |

---

## 6. API 規格概要

### 6.1 API 端點清單

| Method | Path | 說明 | 權限 |
|--------|------|------|------|
| GET | /api/public/health | 健康檢查 | 公開 |
| GET | /api/public/info | 系統資訊 | 公開 |
| GET | /api/user/profile | 取得個人資料 | USER, ADMIN |
| GET | /api/user/resources | 取得資源列表 | USER, ADMIN |
| GET | /api/admin/users | 取得使用者列表 | ADMIN |
| POST | /api/admin/users | 新增使用者 | ADMIN |
| PUT | /api/admin/users/{id} | 更新使用者 | ADMIN |
| DELETE | /api/admin/users/{id} | 刪除使用者 | ADMIN |
| GET | /api/admin/roles | 取得角色列表 | ADMIN |
| GET | /api/admin/settings | 取得系統設定 | ADMIN |

### 6.2 錯誤碼定義

| HTTP Status | 錯誤碼 | 說明 |
|-------------|--------|------|
| 400 | BAD_REQUEST | 請求參數錯誤 |
| 401 | UNAUTHORIZED | 未認證或 Token 無效 |
| 403 | FORBIDDEN | 權限不足 |
| 404 | NOT_FOUND | 資源不存在 |
| 500 | INTERNAL_ERROR | 系統內部錯誤 |

---

## 7. 整合需求

### 7.1 與 LDAP 整合

- Keycloak 透過 User Federation 連接 OpenLDAP
- 使用者資料以 LDAP 為主要來源（Single Source of Truth）
- 支援 LDAP 群組對應到 Keycloak 角色

### 7.2 與現有系統整合

PoC 階段專注於驗證核心功能，暫不涉及與現有系統整合。後續可擴展支援：

- 現有 Web 應用透過 OIDC 整合
- 後端服務透過 OAuth 2.0 Client Credentials 流程
- API Gateway 統一處理 Token 驗證

---

## 8. 驗收標準

### 8.1 PoC 完成定義

- [ ] 所有 Docker 容器可正常啟動
- [ ] OpenLDAP 包含測試使用者資料
- [ ] Keycloak 與 LDAP 整合成功
- [ ] Spring Boot API 可驗證 JWT Token
- [ ] RBAC 權限控制正確運作
- [ ] 提供完整技術文件

### 8.2 測試案例

| 測試案例 | 預期結果 |
|----------|----------|
| 使用 LDAP 帳號登入 Keycloak | 成功取得 Token |
| 使用有效 Token 存取 /api/user/profile | 回傳 200 與使用者資料 |
| 使用無效 Token 存取 API | 回傳 401 Unauthorized |
| USER 角色存取 /api/admin/users | 回傳 403 Forbidden |
| ADMIN 角色存取 /api/admin/users | 回傳 200 與使用者列表 |

---

## 9. 時程規劃

### 9.1 里程碑

| 階段 | 工作項目 | 預計天數 |
|------|----------|----------|
| Phase 1 | 基礎設施建置（LDAP, Keycloak） | 2 天 |
| Phase 2 | Spring Boot API 開發 | 3 天 |
| Phase 3 | 整合測試與文件 | 2 天 |
| **Total** | | **7 天** |

### 9.2 交付物

1. 可執行的 Docker Compose 環境
2. Spring Boot API 原始碼
3. PRD 文件（本文件）
4. 技術架構文件（TECH.md）
5. 基礎設施文件（INFRA.md）
6. API 測試集（Postman Collection）

---

## 10. 風險評估

| 風險項目 | 發生機率 | 影響程度 | 緩解措施 |
|----------|----------|----------|----------|
| LDAP 與 Keycloak 整合問題 | 中 | 高 | 使用官方文件配置，準備備用方案 |
| Token 驗證效能不佳 | 低 | 中 | 使用本地 JWKS 快取 |
| Docker 環境相容性問題 | 低 | 中 | 明確定義版本，提供 troubleshooting 指南 |

---

## 11. 附錄

### 11.1 術語表

| 術語 | 說明 |
|------|------|
| SSO | Single Sign-On，單一登入 |
| RBAC | Role-Based Access Control，角色型存取控制 |
| LDAP | Lightweight Directory Access Protocol，輕量目錄存取協定 |
| JWT | JSON Web Token |
| OIDC | OpenID Connect |
| IdP | Identity Provider，身份提供者 |

### 11.2 參考資料

- [Keycloak Documentation](https://www.keycloak.org/documentation)
- [Spring Security OAuth 2.0](https://docs.spring.io/spring-security/reference/servlet/oauth2/index.html)
- [OpenLDAP Admin Guide](https://www.openldap.org/doc/admin26/)
