# ==============================================================================
# Gateway Service - mTLS Configuration
#
# 說明：啟用雙向 TLS 認證的配置檔
# 啟用方式：SPRING_PROFILES_ACTIVE=mtls 或 --spring.profiles.active=mtls
#
# 憑證來源：cert-manager 自動掛載到 /etc/ssl/certs/
# ==============================================================================

server:
  port: 8080
  ssl:
    enabled: true
    # 服務端憑證 (來自 cert-manager)
    key-store-type: PEM
    key-store: /etc/ssl/certs/tls.crt
    key-store-password: ""
    # 私鑰
    key-alias: gateway
    certificate: /etc/ssl/certs/tls.crt
    certificate-private-key: /etc/ssl/certs/tls.key
    # 客戶端憑證驗證 (對外可選，對內強制)
    client-auth: want  # Gateway 對外接收請求，不強制客戶端憑證
    trust-store-type: PEM
    trust-store: /etc/ssl/certs/ca.crt
    # TLS 版本限制
    protocol: TLS
    enabled-protocols: TLSv1.3,TLSv1.2

spring:
  # SSL Bundle 配置 (Spring Boot 3.1+)
  ssl:
    bundle:
      pem:
        mtls-bundle:
          keystore:
            certificate: /etc/ssl/certs/tls.crt
            private-key: /etc/ssl/certs/tls.key
          truststore:
            certificate: /etc/ssl/certs/ca.crt

  cloud:
    gateway:
      # 配置 HttpClient 使用 mTLS
      httpclient:
        ssl:
          trustedX509Certificates:
            - /etc/ssl/certs/ca.crt
          key-store: /etc/ssl/certs/tls.crt
          key-store-password: ""

      routes:
        # Product Service (使用 HTTPS)
        - id: product-service
          uri: https://product-service.rbac-sso.svc.cluster.local:8081
          predicates:
            - Path=/api/products/**
          filters:
            - StripPrefix=0

        # User Service (使用 HTTPS)
        - id: user-service
          uri: https://user-service.rbac-sso.svc.cluster.local:8082
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=0

# 健康檢查
management:
  server:
    port: 8080
    ssl:
      enabled: true
      certificate: /etc/ssl/certs/tls.crt
      certificate-private-key: /etc/ssl/certs/tls.key
      trust-certificate: /etc/ssl/certs/ca.crt
      client-auth: none

logging:
  level:
    javax.net.ssl: DEBUG
    org.springframework.security: DEBUG
    reactor.netty: DEBUG
